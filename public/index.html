<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vodafone Automation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.4;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }
        
        .main-layout {
            display: flex;
            height: calc(100vh - 80px);
            gap: 1rem;
            padding: 1rem;
        }
        
        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .left-panel {
            width: 380px;
            min-width: 380px;
        }
        
        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .right-panel {
            width: 320px;
            min-width: 320px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            color: #4a5568;
            background: #f8fafc;
        }
        
        .card-body {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }
        
        .config-card {
            height: 200px;
        }
        
        .batches-card {
            flex: 1;
            min-height: 0;
        }
        
        .scripts-card {
            height: 50%;
        }
        
        .status-card {
            height: 50%;
            min-height: 280px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .form-group.full {
            grid-column: span 2;
        }
        
        label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #374151;
        }
        
        input, select, textarea {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.8rem;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-sm {
            padding: 0.375rem 0.5rem;
            font-size: 0.7rem;
        }
        
        .btn-outline {
            background: transparent;
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }
        
        .btn-outline:hover {
            background: #3b82f6;
            color: white;
        }
        
        .btn-red {
            background: #ef4444;
        }
        
        .btn-red:hover {
            background: #dc2626;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 0.75rem;
            overflow-x: auto;
        }
        
        .tab {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
            font-size: 0.75rem;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab-content {
            display: none;
            height: 100%;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .batch-info {
            background: #f3f4f6;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .numbers-textarea {
            flex: 1;
            width: 100%;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.7rem;
            resize: none;
            min-height: 200px;
        }
        
        .scripts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.5rem;
        }
        
        .script-item {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            text-align: center;
            transition: border-color 0.2s;
        }
        
        .script-item:hover {
            border-color: #3b82f6;
        }
        
        .script-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.75rem;
        }
        
        .script-desc {
            font-size: 0.65rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        
        .status-bar {
            background: #f3f4f6;
            padding: 0.75rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-running { background: #f59e0b; }
        .status-completed { background: #10b981; }
        .status-error { background: #ef4444; }
        
        .logs {
            background: #1a202c;
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.65rem;
            height: 200px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            display: none;
            border: 1px solid #374151;
            line-height: 1.3;
        }
        
        .logs.show {
            display: block;
        }
        
        .logs::-webkit-scrollbar {
            width: 6px;
        }
        
        .logs::-webkit-scrollbar-track {
            background: #2d3748;
        }
        
        .logs::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .logs::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .alert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            z-index: 1000;
            max-width: 300px;
        }
        
        .alert-success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .alert-warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 6px;
            padding: 0.75rem;
            text-align: center;
            margin-top: 0.5rem;
            transition: border-color 0.2s;
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
        }
        
        .upload-area input {
            margin: 0;
            font-size: 0.7rem;
        }
        
        .flex {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .flex-between {
            justify-content: space-between;
        }
        
        .text-xs {
            font-size: 0.65rem;
        }
        
        .mb-2 { margin-bottom: 0.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                flex-direction: column;
                height: auto;
                overflow-y: auto;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                flex-direction: row;
                gap: 1rem;
            }
            
            .left-panel .card, .right-panel .card {
                flex: 1;
            }
            
            body {
                overflow: auto;
                height: auto;
            }
        }
        
        @media (max-width: 768px) {
            .left-panel, .right-panel {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .scripts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Vodafone Automation</h1>
    </div>

    <div class="main-layout">
        <!-- Left Panel -->
        <div class="left-panel">
            <!-- Config -->
            <div class="card config-card">
                <div class="card-header">Configuration</div>
                <div class="card-body">
                    <form id="configForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="username" required>
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="password" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Duration (min)</label>
                                <input type="number" id="durationMinutes" value="30" min="1" max="1440" required>
                            </div>
                            <div class="form-group" style="display: flex; align-items: end; gap: 0.5rem;">
                                <button type="submit" class="btn">Save Config</button>
                                <button type="button" class="btn btn-outline" onclick="updateTestFiles()">Update Files</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Batches -->
            <div class="card batches-card">
                <div class="card-header">Phone Number Batches</div>
                <div class="card-body">
                    <div class="tabs">
                        <button class="tab active" data-batch="1">Batch 1</button>
                        <button class="tab" data-batch="2">Batch 2</button>
                        <button class="tab" data-batch="3">Batch 3</button>
                        <button class="tab" data-batch="4">Batch 4</button>
                        <button class="tab" data-batch="5">Batch 5</button>
                        <button class="tab" data-batch="6">Batch 6</button>
                    </div>
                    
                    <!-- Batch Contents -->
                    <div id="batch-1" class="tab-content active">
                        <div class="batch-info flex-between">
                            <span id="batch-1-count">0 numbers</span>
                            <div class="flex">
                                <button class="btn btn-sm" onclick="saveBatch(1)">Save</button>
                                <button class="btn btn-sm btn-outline" onclick="loadBatch(1)">Reload</button>
                            </div>
                        </div>
                        <textarea id="batch-1-numbers" class="numbers-textarea" placeholder="Enter phone numbers, one per line..."></textarea>
                        <div class="upload-area">
                            <input type="file" id="batch-1-file" accept=".txt,.csv" onchange="uploadBatchFile(1)">
                        </div>
                    </div>
                    
                    <div id="batch-2" class="tab-content">
                        <div class="batch-info flex-between">
                            <span id="batch-2-count">0 numbers</span>
                            <div class="flex">
                                <button class="btn btn-sm" onclick="saveBatch(2)">Save</button>
                                <button class="btn btn-sm btn-outline" onclick="loadBatch(2)">Reload</button>
                            </div>
                        </div>
                        <textarea id="batch-2-numbers" class="numbers-textarea" placeholder="Enter phone numbers, one per line..."></textarea>
                        <div class="upload-area">
                            <input type="file" id="batch-2-file" accept=".txt,.csv" onchange="uploadBatchFile(2)">
                        </div>
                    </div>
                    
                    <div id="batch-3" class="tab-content">
                        <div class="batch-info flex-between">
                            <span id="batch-3-count">0 numbers</span>
                            <div class="flex">
                                <button class="btn btn-sm" onclick="saveBatch(3)">Save</button>
                                <button class="btn btn-sm btn-outline" onclick="loadBatch(3)">Reload</button>
                            </div>
                        </div>
                        <textarea id="batch-3-numbers" class="numbers-textarea" placeholder="Enter phone numbers, one per line..."></textarea>
                        <div class="upload-area">
                            <input type="file" id="batch-3-file" accept=".txt,.csv" onchange="uploadBatchFile(3)">
                        </div>
                    </div>
                    
                    <div id="batch-4" class="tab-content">
                        <div class="batch-info flex-between">
                            <span id="batch-4-count">0 numbers</span>
                            <div class="flex">
                                <button class="btn btn-sm" onclick="saveBatch(4)">Save</button>
                                <button class="btn btn-sm btn-outline" onclick="loadBatch(4)">Reload</button>
                            </div>
                        </div>
                        <textarea id="batch-4-numbers" class="numbers-textarea" placeholder="Enter phone numbers, one per line..."></textarea>
                        <div class="upload-area">
                            <input type="file" id="batch-4-file" accept=".txt,.csv" onchange="uploadBatchFile(4)">
                        </div>
                    </div>
                    
                    <div id="batch-5" class="tab-content">
                        <div class="batch-info flex-between">
                            <span id="batch-5-count">0 numbers</span>
                            <div class="flex">
                                <button class="btn btn-sm" onclick="saveBatch(5)">Save</button>
                                <button class="btn btn-sm btn-outline" onclick="loadBatch(5)">Reload</button>
                            </div>
                        </div>
                        <textarea id="batch-5-numbers" class="numbers-textarea" placeholder="Enter phone numbers, one per line..."></textarea>
                        <div class="upload-area">
                            <input type="file" id="batch-5-file" accept=".txt,.csv" onchange="uploadBatchFile(5)">
                        </div>
                    </div>
                    
                    <div id="batch-6" class="tab-content">
                        <div class="batch-info flex-between">
                            <span id="batch-6-count">0 numbers</span>
                            <div class="flex">
                                <button class="btn btn-sm" onclick="saveBatch(6)">Save</button>
                                <button class="btn btn-sm btn-outline" onclick="loadBatch(6)">Reload</button>
                            </div>
                        </div>
                        <textarea id="batch-6-numbers" class="numbers-textarea" placeholder="Enter phone numbers, one per line..."></textarea>
                        <div class="upload-area">
                            <input type="file" id="batch-6-file" accept=".txt,.csv" onchange="uploadBatchFile(6)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel -->
        <div class="center-panel">
            <!-- Scripts -->
            <div class="card scripts-card">
                <div class="card-header">Execute Scripts</div>
                <div class="card-body">
                    <div class="scripts-grid" id="scripts-grid"></div>
                </div>
            </div>

            <!-- Status -->
            <div class="card status-card">
                <div class="card-header">Process Status</div>
                <div class="card-body">
                    <div id="process-status" class="status-bar mb-2">No active processes</div>
                    <button class="btn btn-sm btn-outline" id="toggle-logs" onclick="toggleLogs()" style="display: none;">Show/Hide Logs</button>
                    <div class="logs mt-2" id="logs-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="alerts-container"></div>

    <script>
        let currentProcessId = null;
        let statusInterval = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadAllBatches();
            loadScripts();
            setupTabs();
        });

        // Config
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const config = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                durationMinutes: document.getElementById('durationMinutes').value
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                showAlert(response.ok ? 'Config saved' : result.error, response.ok ? 'success' : 'error');
            } catch (error) {
                showAlert('Failed to save: ' + error.message, 'error');
            }
        });

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                document.getElementById('username').value = config.username || '';
                document.getElementById('password').value = config.password || '';
                document.getElementById('durationMinutes').value = config.durationMinutes || 30;
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // Batches
        async function loadAllBatches() {
            for (let i = 1; i <= 6; i++) {
                await loadBatch(i);
            }
        }

        async function loadBatch(batchNumber) {
            try {
                const response = await fetch(`/api/batches/${batchNumber}`);
                const data = await response.json();
                document.getElementById(`batch-${batchNumber}-numbers`).value = data.numbers.join('\n');
                document.getElementById(`batch-${batchNumber}-count`).textContent = `${data.count} numbers`;
            } catch (error) {
                console.error(`Failed to load batch ${batchNumber}:`, error);
            }
        }

        async function saveBatch(batchNumber) {
            const textarea = document.getElementById(`batch-${batchNumber}-numbers`);
            const numbers = textarea.value.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            
            try {
                const response = await fetch(`/api/batches/${batchNumber}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ numbers })
                });
                
                const result = await response.json();
                if (response.ok) {
                    document.getElementById(`batch-${batchNumber}-count`).textContent = `${result.count} numbers`;
                    showAlert(`Batch ${batchNumber} saved (${result.count} numbers)`, 'success');
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert(`Failed to save batch: ${error.message}`, 'error');
            }
        }

        async function uploadBatchFile(batchNumber) {
            const fileInput = document.getElementById(`batch-${batchNumber}-file`);
            const file = fileInput.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('batchFile', file);
            
            try {
                const response = await fetch(`/api/batches/${batchNumber}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (response.ok) {
                    await loadBatch(batchNumber);
                    showAlert(`Batch ${batchNumber} uploaded (${result.count} numbers)`, 'success');
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert(`Upload failed: ${error.message}`, 'error');
            }
            
            fileInput.value = '';
        }

        // Scripts
        async function loadScripts() {
            try {
                const response = await fetch('/api/scripts');
                const scripts = await response.json();
                
                const grid = document.getElementById('scripts-grid');
                grid.innerHTML = '';
                
                Object.entries(scripts).forEach(([name, cmd]) => {
                    const div = document.createElement('div');
                    div.className = 'script-item';
                    div.innerHTML = `
                        <div class="script-name">${name}</div>
                        <div class="script-desc">${getScriptDesc(name)}</div>
                        <button class="btn btn-sm" onclick="executeScript('${name}')">Run</button>
                    `;
                    grid.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load scripts:', error);
            }
        }

        function getScriptDesc(name) {
            const descs = {
                'batch:continuous:all': 'Run all batches + report',
                'batch1:continuous': 'Run batch 1 continuous',
                'batch2:continuous': 'Run batch 2 continuous',
                'batch3:continuous': 'Run batch 3 continuous',
                'batch4:continuous': 'Run batch 4 continuous',
                'login': 'Test login',
                'generate:report': 'Generate HTML report',
                'generate:consolidated': 'Consolidated report'
            };
            return descs[name] || 'Run automation script';
        }

        async function executeScript(scriptName) {
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ script: scriptName })
                });
                
                const result = await response.json();
                if (response.ok) {
                    currentProcessId = result.processId;
                    startMonitoring();
                    showAlert(`Started: ${scriptName}`, 'success');
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert('Execute failed: ' + error.message, 'error');
            }
        }

        async function updateTestFiles() {
            try {
                const response = await fetch('/api/config/update-files', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                if (response.ok) {
                    showAlert(`Test files updated: ${result.updatedCount}/${result.totalFiles} files`, 'success');
                } else {
                    showAlert(`Update failed: ${result.message}`, 'error');
                }
            } catch (error) {
                showAlert('Update failed: ' + error.message, 'error');
            }
        }

        function startMonitoring() {
            if (statusInterval) clearInterval(statusInterval);
            
            statusInterval = setInterval(async () => {
                if (!currentProcessId) return;
                
                try {
                    const [statusRes, logsRes] = await Promise.all([
                        fetch(`/api/process/${currentProcessId}`),
                        fetch(`/api/process/${currentProcessId}/logs`)
                    ]);
                    
                    const status = await statusRes.json();
                    const logs = await logsRes.json();
                    
                    updateStatus(status, logs);
                    
                    if (status.completed) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                    }
                } catch (error) {
                    console.error('Monitor error:', error);
                }
            }, 1000);
        }

        function updateStatus(status, logs) {
            const statusDiv = document.getElementById('process-status');
            const logsDiv = document.getElementById('logs-container');
            const toggleBtn = document.getElementById('toggle-logs');
            
            const indicator = status.completed ? 
                (status.exitCode === 0 ? 'status-completed' : 'status-error') : 
                'status-running';
            
            statusDiv.innerHTML = `
                <div class="flex-between">
                    <span>
                        <span class="status-indicator ${indicator}"></span>
                        ${status.script} - ${status.status}
                    </span>
                    ${!status.completed ? 
                        `<button class="btn btn-sm btn-red" onclick="stopProcess()">Stop</button>` : 
                        ''
                    }
                </div>
                <div class="text-xs mt-2">Started: ${new Date(status.startTime).toLocaleString()}</div>
            `;
            
            logsDiv.textContent = logs.output + logs.error;
            toggleBtn.style.display = 'block';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        async function stopProcess() {
            if (!currentProcessId) return;
            
            try {
                const response = await fetch(`/api/process/${currentProcessId}/stop`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                showAlert(response.ok ? 'Process stopped' : result.error, response.ok ? 'warning' : 'error');
            } catch (error) {
                showAlert('Stop failed: ' + error.message, 'error');
            }
        }

        function toggleLogs() {
            document.getElementById('logs-container').classList.toggle('show');
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const batchNumber = tab.dataset.batch;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`batch-${batchNumber}`).classList.add('active');
                });
            });
        }

        function showAlert(message, type) {
            const container = document.getElementById('alerts-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.appendChild(alert);
            
            setTimeout(() => alert.remove(), 4000);
        }
    </script>
</body>
</html>